<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}Savannah{% endblock %}</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f5;
        color: #333;
      }
      nav {
        background: #2c3e50;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      nav .nav-left a {
        color: white;
        text-decoration: none;
        font-size: 20px;
        font-weight: bold;
      }
      nav .nav-links a {
        color: white;
        text-decoration: none;
        margin-left: 15px;
        font-size: 16px;
        position: relative;
      }
      nav .nav-links a:hover {
        text-decoration: underline;
      }
      .cart-badge {
        position: absolute;
        top: -8px;
        right: -10px;
        background: red;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        font-weight: bold;
      }
      .container {
        max-width: 1000px;
        margin: 20px auto;
        padding: 0 15px;
      }
      h1,
      h2 {
        color: #2c3e50;
      }
      #toast {
        visibility: hidden;
        min-width: 200px;
        background-color: #27ae60;
        color: white;
        text-align: center;
        border-radius: 5px;
        padding: 10px;
        position: fixed;
        z-index: 1000;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
      }
      #toast.show {
        visibility: visible;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }
      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }
      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <div class="nav-left">
        <a href="/">Savannah</a>
      </div>
      <div class="nav-links">
        <a href="/products/">Products</a>

        {% if user.is_authenticated %}
        <a href="{% url 'orders_list' %}">Orders</a>
        <a
          href="{% url 'cart_view' %}"
          style="position: relative; display: inline-block"
        >
          ðŸ›’ Cart <span id="cart-count" class="cart-badge">0</span>
        </a>
        <form
          action="{% url 'account_logout' %}"
          method="post"
          style="display: inline"
        >
          {% csrf_token %}
          <button
            type="submit"
            style="
              background: none;
              border: none;
              color: white;
              cursor: pointer;
            "
            onclick="sessionStorage.removeItem('cartCount');"
          >
            Logout
          </button>
        </form>
        {% else %}
        <a href="{% url 'account_login' %}">Login</a>
        {% comment %} <a href="{% url 'account_signup' %}">Sign Up</a> {% endcomment %}
        {% endif %}
      </div>
    </nav>

    <div class="container">{% block content %}{% endblock %}</div>

    <div id="toast">Product added to cart!</div>

    <script>
      const csrfToken = "{{ csrf_token }}";

      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "show";
        setTimeout(() => {
          toast.className = toast.className.replace("show", "");
        }, 3000);
      }

      function updateCartBadge(count) {
        const cartCount = document.getElementById("cart-count");
        if (cartCount) {
          cartCount.textContent = count;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Clear cart count when a user logs in or out
        sessionStorage.removeItem("cartCount");

        // Load current user's cart count
        fetch("{% url 'cart_count' %}")
          .then((res) => res.json())
          .then((data) => updateCartBadge(data.cart_count));
      });

      async function addToCart(form) {
        const formData = new FormData(form);
        const res = await fetch(form.action, {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken },
          body: formData,
        });
        const data = await res.json();
        if (data.success) {
          updateCartBadge(data.cart_count);
          showToast("Product added to cart!");
          form.querySelector('input[name="quantity"]').value = 1;
        } else if (data.error === "not_authenticated") {
          window.location.href = "{% url 'account_login' %}";
        }
      }

      async function updateCart(itemId, quantity) {
        const res = await fetch("{% url 'update_cart' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify({ item_id: itemId, quantity }),
        });
        const data = await res.json();
        if (data.success) {
          updateCartBadge(data.cart_count);
        }
        return data;
      }

      async function removeCart(itemId) {
        const res = await fetch("{% url 'remove_cart_item' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify({ item_id: itemId }),
        });
        const data = await res.json();
        if (data.success) {
          updateCartBadge(data.cart_count);
        }
        return data;
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Load cart count from sessionStorage if available
        const savedCount = sessionStorage.getItem("cartCount");
        if (savedCount !== null) {
          updateCartBadge(savedCount);
        } else {
          fetch("{% url 'cart_count' %}")
            .then((res) => res.json())
            .then((data) => updateCartBadge(data.cart_count));
        }

        // Handle add-to-cart forms
        document.querySelectorAll(".add-to-cart-form").forEach((form) => {
          form.addEventListener("submit", (e) => {
            e.preventDefault();
            addToCart(form);
          });
        });

        // Handle cart page increment/decrement/remove buttons
        document.querySelectorAll("tr[data-item-id]").forEach((row) => {
          const itemId = row.dataset.itemId;
          const input = row.querySelector(".quantity-input");
          const subtotalCell = row.querySelector(".subtotal");

          row
            .querySelector(".increment-btn")
            ?.addEventListener("click", async () => {
              input.value = parseInt(input.value) + 1;
              const data = await updateCart(itemId, input.value);
              if (data.success) {
                subtotalCell.textContent = "Ksh " + data.subtotal;
                document.getElementById("cart-total").textContent = data.total;
              }
            });

          row
            .querySelector(".decrement-btn")
            ?.addEventListener("click", async () => {
              if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
                const data = await updateCart(itemId, input.value);
                if (data.success) {
                  subtotalCell.textContent = "Ksh " + data.subtotal;
                  document.getElementById("cart-total").textContent =
                    data.total;
                }
              }
            });

          row
            .querySelector(".remove-btn")
            ?.addEventListener("click", async () => {
              const data = await removeCart(itemId);
              if (data.success) {
                row.remove();
                document.getElementById("cart-total").textContent = data.total;
                showToast("Item removed from cart!");
                if (
                  document.querySelectorAll("tr[data-item-id]").length === 0
                ) {
                  const container = document.querySelector(".container");
                  container.innerHTML += "<p>Your cart is empty.</p>";
                }
              }
            });

          input?.addEventListener("change", async () => {
            if (parseInt(input.value) < 1) input.value = 1;
            const data = await updateCart(itemId, input.value);
            if (data.success) {
              subtotalCell.textContent = "Ksh " + data.subtotal;
              document.getElementById("cart-total").textContent = data.total;
            }
          });
        });
      });
    </script>
  </body>
</html>
